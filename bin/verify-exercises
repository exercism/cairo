#!/usr/bin/env bash

# Synopsis:
# Test the track's exercises.
# 
# At a minimum, this file must check if the example/exemplar solution of each 
# Practice/Concept Exercise passes the exercise's tests.
#
# To check this, you usually have to (temporarily) replace the exercise's solution files
# with its exemplar/example files.
#
# If your track uses skipped tests, make sure to (temporarily) enable these tests
# before running the tests.
#
# The path to the solution/example/exemplar files can be found in the exercise's
# .meta/config.json file, or possibly inferred from the exercise's directory name.

# Example: verify all exercises
# ./bin/verify-exercises

# Example: verify single exercise
# ./bin/verify-exercises two-fer

repo=$(git rev-parse --show-toplevel)

lib_cairo="./src/lib.cairo"

verify_exercise() {
    exercises_path="$repo/exercises/$1"
    source_file_name="$2"
    tmp_file=$(mktemp)
    
    for exercise_dir in "$exercises_path"/*; do
        if [ -z $exercise_dir ]; then
            continue
        fi
        
        slug=$(basename "$exercise_dir")
        echo "Checking $slug exercise..."
        
        cd "$exercise_dir"
        
        solution_file=".meta/$source_file_name.cairo"
        if [ -z "$solution_file" ]; then
            echo "Could not find solution for $1"
            exit 1
        fi
        
        # since we're testing the solution, we need to temporarily replace
        # the exercise's solution files with its exemplar/example files
        cp "$lib_cairo" "$tmp_file"
        cp "$solution_file" "$lib_cairo"
        
        scarb cairo-test
        
        cp "$tmp_file" "$lib_cairo"
    done
    
    rm $tmp_file
}

# https://github.com/exercism/docs/blob/main/anatomy/tracks/concept-exercises.md#file-exemplar-implementation
# verify_exercise "concept" "exemplar"
# https://github.com/exercism/docs/blob/main/anatomy/tracks/practice-exercises.md#file-example-implementation
verify_exercise "practice" "example"
